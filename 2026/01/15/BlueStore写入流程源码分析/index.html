<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>BlueStore写入流程源码分析 | Hexo</title><meta name="author" content="Rebellion"><meta name="copyright" content="Rebellion"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="一、准备工作1、配置ceph.conf，防止osd_op_thread线程超时suicide在ceph.conf文件的OSD组中添加字段osd_op_thread_suicide_timeout &#x3D; 1800来调整osd_op_thread的自杀时间（单位秒），避免时间过短导致osd_op_thread影响调试 1234567&#x2F;&#x2F;file:ceph.conf...[OSD]...osd_">
<meta property="og:type" content="article">
<meta property="og:title" content="BlueStore写入流程源码分析">
<meta property="og:url" content="https://rebelliousness.github.io/2026/01/15/BlueStore%E5%86%99%E5%85%A5%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="一、准备工作1、配置ceph.conf，防止osd_op_thread线程超时suicide在ceph.conf文件的OSD组中添加字段osd_op_thread_suicide_timeout &#x3D; 1800来调整osd_op_thread的自杀时间（单位秒），避免时间过短导致osd_op_thread影响调试 1234567&#x2F;&#x2F;file:ceph.conf...[OSD]...osd_">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://rebelliousness.github.io/img/butterfly-icon.png">
<meta property="article:published_time" content="2026-01-14T16:25:14.000Z">
<meta property="article:modified_time" content="2026-01-15T16:08:24.352Z">
<meta property="article:author" content="Rebellion">
<meta property="article:tag" content="ceph">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://rebelliousness.github.io/img/butterfly-icon.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "BlueStore写入流程源码分析",
  "url": "https://rebelliousness.github.io/2026/01/15/BlueStore%E5%86%99%E5%85%A5%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/",
  "image": "https://rebelliousness.github.io/img/butterfly-icon.png",
  "datePublished": "2026-01-14T16:25:14.000Z",
  "dateModified": "2026-01-15T16:08:24.352Z",
  "author": [
    {
      "@type": "Person",
      "name": "Rebellion",
      "url": "https://Rebelliousness.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://rebelliousness.github.io/2026/01/15/BlueStore%E5%86%99%E5%85%A5%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'BlueStore写入流程源码分析',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 8.0.0"></head><body><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Hexo</span></a><a class="nav-page-title" href="/"><span class="site-name">BlueStore写入流程源码分析</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"></div></nav><div id="post-info"><h1 class="post-title">BlueStore写入流程源码分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2026-01-14T16:25:14.000Z" title="Created 2026-01-15 00:25:14">2026-01-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2026-01-15T16:08:24.352Z" title="Updated 2026-01-16 00:08:24">2026-01-16</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h3 id="一、准备工作"><a href="#一、准备工作" class="headerlink" title="一、准备工作"></a>一、准备工作</h3><h4 id="1、配置ceph-conf，防止osd-op-thread线程超时suicide"><a href="#1、配置ceph-conf，防止osd-op-thread线程超时suicide" class="headerlink" title="1、配置ceph.conf，防止osd_op_thread线程超时suicide"></a>1、配置ceph.conf，防止osd_op_thread线程超时suicide</h4><p>在ceph.conf文件的OSD组中添加字段osd_op_thread_suicide_timeout &#x3D; 1800来调整osd_op_thread的自杀时间（单位秒），避免时间过短导致osd_op_thread影响调试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//file:ceph.conf</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">[OSD]</span><br><span class="line">...</span><br><span class="line">osd_op_thread_suicide_timeout = 1800</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h4 id="2、创建pool"><a href="#2、创建pool" class="headerlink" title="2、创建pool"></a>2、创建pool</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ./build</span><br><span class="line">./bin/ceph --conf ./ceph.conf osd pool create mypool 64 64</span><br><span class="line"><span class="comment"># 查看该pool详细信息（副本数、PG数、状态等）</span></span><br><span class="line">./bin/ceph --conf ./ceph.conf osd pool get mypool all</span><br></pre></td></tr></table></figure>

<p><img src="image-20251224223832945.png" alt="image-20251224223832945"></p>
<h4 id="3、ceph之bufferlist"><a href="#3、ceph之bufferlist" class="headerlink" title="3、ceph之bufferlist"></a>3、ceph之bufferlist</h4><p><img src="buffer.drawio.png" alt="buffer.drawio"></p>
<h3 id="二、写入流程堆栈"><a href="#二、写入流程堆栈" class="headerlink" title="二、写入流程堆栈"></a>二、写入流程堆栈</h3><p>通过如下命令向mypool写入对象my_first_object</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">touch</span> ./myoutput/hello_ceph.txt</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Hello Ceph Pool&quot;</span> &gt; ./myoutput/hello_ceph.txt</span><br><span class="line">./bin/rados --conf ./ceph.conf put my_first_object ./myoutput/hello_ceph.txt -p mypool</span><br></pre></td></tr></table></figure>

<p>tp_osd_tp线程堆栈如下所示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#0  BlueStore::queue_transactions (this=0x555558a95e00, ch=..., tls=std::vector of length 1, capacity 1 = &#123;...&#125;, op=..., handle=0x0) at /home/rebellion/clone/ceph/src/os/bluestore/BlueStore.cc:15665</span></span><br><span class="line"><span class="comment">#1  0x0000555556e0531e in PrimaryLogPG::queue_transactions (this=&lt;optimized out&gt;, tls=..., op=...) at /home/rebellion/clone/ceph/src/osd/PrimaryLogPG.h:385</span></span><br><span class="line"><span class="comment">#2  0x0000555557075dc5 in ReplicatedBackend::submit_transaction (this=this@entry=0x55555979a990, soid=..., delta_stats=..., at_version=..., _t=..., trim_to=..., pg_committed_to=..., _log_entries=..., hset_history=std::optional&lt;pg_hit_set_history_t&gt; [no contained value], on_all_commit=&lt;optimized out&gt;, tid=&lt;optimized out&gt;, reqid=..., orig_op=...) at /home/rebellion/clone/ceph/src/osd/ReplicatedBackend.cc:664</span></span><br><span class="line"><span class="comment">#3  0x0000555556da7332 in PrimaryLogPG::issue_repop (this=this@entry=0x555558f20720, repop=repop@entry=0x7ffebc004b60, ctx=ctx@entry=0x7ffebc00d000) at /home/rebellion/clone/ceph/src/osd/PrimaryLogPG.cc:11548</span></span><br><span class="line"><span class="comment">#4  0x0000555556df140f in PrimaryLogPG::execute_ctx (this=this@entry=0x555558f20720, ctx=ctx@entry=0x7ffebc00d000) at /home/rebellion/clone/ceph/src/osd/PrimaryLogPG.cc:4424</span></span><br><span class="line"><span class="comment">#5  0x0000555556df58e2 in PrimaryLogPG::do_op (this=this@entry=0x555558f20720, op=...) at /home/rebellion/clone/ceph/src/osd/PrimaryLogPG.cc:2556</span></span><br><span class="line"><span class="comment">#6  0x0000555556e02d9b in PrimaryLogPG::do_request (this=0x555558f20720, op=..., handle=...) at /home/rebellion/clone/ceph/src/osd/PrimaryLogPG.cc:1938</span></span><br><span class="line"><span class="comment">#7  0x0000555556c9bc6d in OSD::dequeue_op (this=this@entry=0x555558c466a0, pg=..., op=..., handle=...) at /home/rebellion/clone/ceph/src/osd/OSD.cc:9958</span></span><br><span class="line"><span class="comment">#8  0x0000555556f10307 in ceph::osd::scheduler::PGOpItem::run (this=&lt;optimized out&gt;, osd=0x555558c466a0, sdata=&lt;optimized out&gt;, pg=..., handle=...) at /home/rebellion/clone/ceph/src/osd/scheduler/OpSchedulerItem.cc:29</span></span><br><span class="line"><span class="comment">#9  0x0000555556cb7e3d in ceph::osd::scheduler::OpSchedulerItem::run (handle=..., pg=..., sdata=&lt;optimized out&gt;, osd=&lt;optimized out&gt;, this=0x7fff75ffc7b0) at /home/rebellion/clone/ceph/src/osd/scheduler/OpSchedulerItem.h:137</span></span><br><span class="line"><span class="comment">#10 OSD::ShardedOpWQ::_process (this=0x555558c47998, thread_index=&lt;optimized out&gt;, shard_index=&lt;optimized out&gt;, hb=0x7ffebc000e40) at /home/rebellion/clone/ceph/src/osd/OSD.cc:11393</span></span><br><span class="line"><span class="comment">#11 0x000055555727f17e in ShardedThreadPool::shardedthreadpool_worker (this=0x555558c472f8, thread_index=&lt;optimized out&gt;, shard_index=4) at /home/rebellion/clone/ceph/src/common/WorkQueue.cc:346</span></span><br><span class="line"><span class="comment">#12 0x0000555557281a48 in ShardedThreadPool::WorkThreadSharded::entry (this=&lt;optimized out&gt;) at /home/rebellion/clone/ceph/src/common/WorkQueue.h:665</span></span><br><span class="line"><span class="comment">#13 0x0000555557272f7d in Thread::entry_wrapper (this=0x5555595c0390) at /home/rebellion/clone/ceph/src/common/Thread.cc:88</span></span><br><span class="line"><span class="comment">#14 0x0000555557272f93 in Thread::_entry_func (arg=&lt;optimized out&gt;) at /home/rebellion/clone/ceph/src/common/Thread.cc:75</span></span><br><span class="line"><span class="comment">#15 0x00007ffff7094ac3 in start_thread (arg=&lt;optimized out&gt;) at ./nptl/pthread_create.c:442</span></span><br><span class="line"><span class="comment">#16 0x00007ffff71268c0 in clone3 () at ../sysdeps/unix/sysv/linux/x86_64/clone3.S:81</span></span><br></pre></td></tr></table></figure>

<p>OSD收到rados的写入请求后通过BlueStore::queue_transactions进行对象的写入。</p>
<p>该写入请求{“my_first_object”:”Hello Ceph Pool”}如下图所示的操作：</p>
<p><img src="Snipaste_2026-01-12_21-38-37.png" alt="Snipaste_2026-01-12_21-38-37"></p>
<p><img src="op_bl.drawio.png" alt="op_bl.drawio"></p>
<h3 id="三、BlueStore-queue-transactions源码分析"><a href="#三、BlueStore-queue-transactions源码分析" class="headerlink" title="三、BlueStore::queue_transactions源码分析"></a>三、BlueStore::queue_transactions源码分析</h3><p>BlueStore统一通过BlueStore::queue_transactions进行事务处理，写事务的处理流程如下所示：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//file:BlueStore.cc</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">BlueStore::queue_transactions</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  CollectionHandle&amp; ch,</span></span></span><br><span class="line"><span class="params"><span class="function">  vector&lt;Transaction&gt;&amp; tls,</span></span></span><br><span class="line"><span class="params"><span class="function">  TrackedOpRef op,</span></span></span><br><span class="line"><span class="params"><span class="function">  ThreadPool::TPHandle *handle)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">//1</span></span><br><span class="line">  list&lt;Context*&gt; on_applied, on_commit, on_applied_sync;</span><br><span class="line">  ObjectStore::Transaction::<span class="built_in">collect_contexts</span>(tls, &amp;on_applied, &amp;on_commit,</span><br><span class="line">                                             &amp;on_applied_sync);</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">//2</span></span><br><span class="line">  Collection* c = <span class="built_in">static_cast</span>&lt;Collection*&gt;(ch.<span class="built_in">get</span>());</span><br><span class="line">  OpSequencer* osr = c-&gt;osr.<span class="built_in">get</span>();</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">//3</span></span><br><span class="line">  <span class="comment">// prepare</span></span><br><span class="line">  TransContext* txc =</span><br><span class="line">      _txc_create(<span class="built_in">static_cast</span>&lt;Collection*&gt;(ch.<span class="built_in">get</span>()), osr, &amp;on_commit, op);</span><br><span class="line">  <span class="comment">//4</span></span><br><span class="line">  <span class="keyword">for</span> (vector&lt;Transaction&gt;::iterator p = tls.<span class="built_in">begin</span>(); p != tls.<span class="built_in">end</span>(); ++p) &#123;</span><br><span class="line">    txc-&gt;bytes += (*p).<span class="built_in">get_num_bytes</span>();</span><br><span class="line">    _txc_add_transaction(txc, &amp;(*p));</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">//5</span></span><br><span class="line">  _txc_calc_cost(txc);</span><br><span class="line">  _txc_write_nodes(txc, txc-&gt;t);</span><br><span class="line">  <span class="comment">//6</span></span><br><span class="line">  <span class="comment">// journal deferred items</span></span><br><span class="line">  <span class="keyword">if</span> (txc-&gt;deferred_txn) &#123;</span><br><span class="line">    txc-&gt;deferred_txn-&gt;seq = ++deferred_seq;</span><br><span class="line">    bufferlist bl;</span><br><span class="line">    <span class="built_in">encode</span>(*txc-&gt;deferred_txn, bl);</span><br><span class="line">    string key;</span><br><span class="line">    <span class="built_in">get_deferred_key</span>(txc-&gt;deferred_txn-&gt;seq, &amp;key);</span><br><span class="line">    txc-&gt;t-&gt;<span class="built_in">set</span>(PREFIX_DEFERRED, key, bl);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//7</span></span><br><span class="line">  _txc_finalize_kv(txc, txc-&gt;t);</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">//8</span></span><br><span class="line">  <span class="keyword">if</span> (!throttle.<span class="built_in">try_start_transaction</span>(*db, *txc, tstart)) &#123;</span><br><span class="line">    <span class="comment">// ensure we do not block here because of deferred writes</span></span><br><span class="line">    <span class="built_in">dout</span>(<span class="number">10</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; failed get throttle_deferred_bytes, aggressive&quot;</span></span><br><span class="line">             &lt;&lt; dendl;</span><br><span class="line">    ++deferred_aggressive;</span><br><span class="line">    <span class="built_in">deferred_try_submit</span>();</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// wake up any previously finished deferred events</span></span><br><span class="line">      <span class="function">std::lock_guard <span class="title">l</span><span class="params">(kv_lock)</span></span>;</span><br><span class="line">      <span class="keyword">if</span> (!kv_sync_in_progress) &#123;</span><br><span class="line">        kv_sync_in_progress = <span class="literal">true</span>;</span><br><span class="line">        kv_cond.<span class="built_in">notify_one</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    throttle.<span class="built_in">finish_start_transaction</span>(*db, *txc, tstart);</span><br><span class="line">    --deferred_aggressive;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">//9</span></span><br><span class="line">  _txc_state_proc(txc);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>将每个事务的on_applied、on_commit以及on_applied_sync回调函数分别加入到on_applied、on_commit以及on_applied_sync中</li>
<li>根据CollectionHandle&amp; ch参数获取Collection，通过Collection获取对应的OpSequencer</li>
<li>创建一个TransContext* txc，TransContext表示一个关于事务组的状态机上下文</li>
<li>_txc_add_transaction对每个事务的元数据的查找或创建，接着对事务的操作类型调用相应的函数，Transaction::OP_WRITE调用BlueStore::_write函数执行异步DirectIO写入操作或者执行延迟写入</li>
<li>计算所有io的消耗，用于后续限流操作（写抑制），接着_txc_write_nodes将元数据更新操作加入RocksDB事务的WriteBatch中</li>
<li>若有延迟写入，则将该操作加入RocksDB事务的WriteBatch中</li>
<li>更新空间分配（freelistmanager），删除失效的kv数据</li>
<li>执行限流操作</li>
<li>_txc_state_proc执行txc对应状态的行为并进行状态转移，此时txc状态为STATE_PREPARE</li>
</ol>
<h4 id="1、BlueStore-txc-add-transaction"><a href="#1、BlueStore-txc-add-transaction" class="headerlink" title="1、BlueStore::_txc_add_transaction"></a>1、BlueStore::_txc_add_transaction</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//file:BlueStore.cc</span></span><br><span class="line"><span class="comment">//backtrace:BlueStore::queue_transactions-&gt;BlueStore::_txc_add_transaction</span></span><br><span class="line"><span class="type">void</span> BlueStore::_txc_add_transaction(TransContext *txc, Transaction *t)</span><br><span class="line">&#123;</span><br><span class="line">  Transaction::iterator i = t-&gt;<span class="built_in">begin</span>();</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">//创建与事务objects数量相同的OnodeRef vector</span></span><br><span class="line">	<span class="function">vector&lt;OnodeRef&gt; <span class="title">ovec</span><span class="params">(i.objects.size())</span></span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> pos = <span class="number">0</span>; i.<span class="built_in">have_op</span>(); ++pos) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// object operations</span></span><br><span class="line">		<span class="comment">// 通过op-&gt;oid获取ovec中对应的OnodeRef&amp; o，若o为空则在事务对应的collection中查找</span></span><br><span class="line">    <span class="function">std::unique_lock <span class="title">l</span><span class="params">(c-&gt;lock)</span></span>;</span><br><span class="line">    OnodeRef&amp; o = ovec[op-&gt;oid];</span><br><span class="line">    <span class="keyword">if</span> (!o) &#123;</span><br><span class="line">      <span class="type">ghobject_t</span> oid = i.<span class="built_in">get_oid</span>(op-&gt;oid);</span><br><span class="line">      o = c-&gt;<span class="built_in">get_onode</span>(oid, create, op-&gt;op == Transaction::OP_CREATE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!create &amp;&amp; (!o || !o-&gt;exists)) &#123;</span><br><span class="line">      <span class="built_in">dout</span>(<span class="number">10</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; op &quot;</span> &lt;&lt; op-&gt;op &lt;&lt; <span class="string">&quot; got ENOENT on &quot;</span></span><br><span class="line">               &lt;&lt; i.<span class="built_in">get_oid</span>(op-&gt;oid) &lt;&lt; dendl;</span><br><span class="line">      r = -ENOENT;</span><br><span class="line">      <span class="keyword">goto</span> endop;</span><br><span class="line">    &#125;</span><br><span class="line">   	...</span><br><span class="line">    <span class="comment">//根据op-&gt;op执行对应操作</span></span><br><span class="line">    <span class="keyword">switch</span> (op-&gt;op) &#123;</span><br><span class="line">		...</span><br><span class="line">      <span class="keyword">case</span> Transaction::OP_CREATE:</span><br><span class="line">      <span class="keyword">case</span> Transaction::OP_TOUCH:</span><br><span class="line">        r = _touch(txc, c, o);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> Transaction::OP_WRITE: &#123;</span><br><span class="line">        <span class="type">uint64_t</span> off = op-&gt;off;</span><br><span class="line">        <span class="type">uint64_t</span> len = op-&gt;len;</span><br><span class="line">        <span class="type">uint32_t</span> fadvise_flags = i.<span class="built_in">get_fadvise_flags</span>();</span><br><span class="line">        bufferlist bl;</span><br><span class="line">        i.<span class="built_in">decode_bl</span>(bl);</span><br><span class="line">        r = _write(txc, c, o, off, len, bl, fadvise_flags);</span><br><span class="line">      &#125; <span class="keyword">break</span>;</span><br><span class="line">		...</span><br><span class="line">    <span class="keyword">case</span> Transaction::OP_SETATTRS: &#123;</span><br><span class="line">        map&lt;string, bufferptr&gt; aset;</span><br><span class="line">        i.<span class="built_in">decode_attrset</span>(aset);</span><br><span class="line">        r = _setattrs(txc, c, o, aset);</span><br><span class="line">      &#125; <span class="keyword">break</span>;</span><br><span class="line">    ...</span><br><span class="line">	<span class="keyword">case</span> Transaction::OP_OMAP_SETKEYS: &#123;</span><br><span class="line">        bufferlist aset_bl;</span><br><span class="line">        i.<span class="built_in">decode_attrset_bl</span>(&amp;aset_bl);</span><br><span class="line">        r = _omap_setkeys(txc, c, o, aset_bl);</span><br><span class="line">      &#125; <span class="keyword">break</span>;</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//file:BlueStore.cc</span></span><br><span class="line"><span class="comment">//backtrace:BlueStore::queue_transactions-&gt;BlueStore::_txc_add_transaction-&gt;BlueStore::_write</span></span><br><span class="line"><span class="type">int</span> BlueStore::_write(TransContext* txc, CollectionRef&amp; c, OnodeRef&amp; o,</span><br><span class="line">                      <span class="type">uint64_t</span> offset, <span class="type">size_t</span> length, bufferlist&amp; bl,</span><br><span class="line">                      <span class="type">uint32_t</span> fadvise_flags)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">//检查此次写入是否超过单个对象最大限制</span></span><br><span class="line">  <span class="keyword">if</span> (offset + length &gt;= OBJECT_MAX_SIZE) &#123;</span><br><span class="line">    r = -E2BIG;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    _assign_nid(txc, o);	<span class="comment">//为onode分配nid</span></span><br><span class="line">   	<span class="comment">// 根据use_write_v2标志执行_do_write_v2或者_do_write</span></span><br><span class="line">    <span class="keyword">if</span> (use_write_v2) &#123;</span><br><span class="line">      r = _do_write_v2(txc, c, o, offset, length, bl, fadvise_flags);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      r = _do_write(txc, c, o, offset, length, bl, fadvise_flags);</span><br><span class="line">    &#125;</span><br><span class="line">    txc-&gt;<span class="built_in">write_onode</span>(o);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//file:BlueStore.cc</span></span><br><span class="line"><span class="comment">//backtrace:BlueStore::queue_transactions-&gt;BlueStore::_txc_add_transaction-&gt;BlueStore::_write-&gt;BlueStore::_do_write</span></span><br><span class="line"><span class="type">int</span> BlueStore::_do_write(TransContext* txc, CollectionRef&amp; c, OnodeRef&amp; o,</span><br><span class="line">                         <span class="type">uint64_t</span> offset, <span class="type">uint64_t</span> length, bufferlist&amp; bl,</span><br><span class="line">                         <span class="type">uint32_t</span> fadvise_flags) </span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> r = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">dout</span>(<span class="number">20</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; o-&gt;oid &lt;&lt; <span class="string">&quot; 0x&quot;</span> &lt;&lt; std::hex &lt;&lt; offset &lt;&lt; <span class="string">&quot;~&quot;</span></span><br><span class="line">           &lt;&lt; length &lt;&lt; <span class="string">&quot; - have 0x&quot;</span> &lt;&lt; o-&gt;onode.size &lt;&lt; <span class="string">&quot; (&quot;</span> &lt;&lt; std::dec</span><br><span class="line">           &lt;&lt; o-&gt;onode.size &lt;&lt; <span class="string">&quot;)&quot;</span></span><br><span class="line">           &lt;&lt; <span class="string">&quot; bytes&quot;</span> &lt;&lt; std::hex &lt;&lt; <span class="string">&quot; fadvise_flags 0x&quot;</span> &lt;&lt; fadvise_flags</span><br><span class="line">           &lt;&lt; <span class="string">&quot; alloc_hint 0x&quot;</span> &lt;&lt; o-&gt;onode.alloc_hint_flags</span><br><span class="line">           &lt;&lt; <span class="string">&quot; expected_object_size &quot;</span> &lt;&lt; o-&gt;onode.expected_object_size</span><br><span class="line">           &lt;&lt; <span class="string">&quot; expected_write_size &quot;</span> &lt;&lt; o-&gt;onode.expected_write_size</span><br><span class="line">           &lt;&lt; std::dec &lt;&lt; dendl;</span><br><span class="line">  _dump_onode&lt;<span class="number">30</span>&gt;(cct, *o);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (length == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">uint64_t</span> end = offset + length;</span><br><span class="line"></span><br><span class="line">  <span class="function">GarbageCollector <span class="title">gc</span><span class="params">(c-&gt;store-&gt;cct)</span></span>;</span><br><span class="line">  <span class="type">int64_t</span> benefit = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">auto</span> dirty_start = offset;</span><br><span class="line">  <span class="keyword">auto</span> dirty_end = end;</span><br><span class="line">	</span><br><span class="line">  <span class="comment">//创建writeContext wctx</span></span><br><span class="line">  WriteContext wctx;</span><br><span class="line">  <span class="comment">//设置写入选项，例如设置是否写入buffer、校验以及压缩选项等</span></span><br><span class="line">  _choose_write_options(c, o, fadvise_flags, &amp;wctx);</span><br><span class="line">  <span class="comment">//加载涉及范围内的所有extent到extent_map中(主要针对开启分片功能情况)</span></span><br><span class="line">  o-&gt;extent_map.<span class="built_in">fault_range</span>(db, offset, length);</span><br><span class="line">  <span class="comment">//执行数据的大小写处理</span></span><br><span class="line">  _do_write_data(txc, c, o, offset, length, bl, &amp;wctx);</span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  r = _do_alloc_write(txc, c, o, &amp;wctx);</span><br><span class="line">  <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    derr &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; _do_alloc_write failed with &quot;</span> &lt;&lt; <span class="built_in">cpp_strerror</span>(r)</span><br><span class="line">         &lt;&lt; dendl;</span><br><span class="line">    <span class="keyword">goto</span> out;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (wctx.extents_to_gc.<span class="built_in">empty</span>() || wctx.extents_to_gc.<span class="built_in">range_start</span>() &gt; offset ||</span><br><span class="line">      wctx.extents_to_gc.<span class="built_in">range_end</span>() &lt; offset + length) &#123;</span><br><span class="line">    benefit = gc.<span class="built_in">estimate</span>(offset, length, o-&gt;extent_map, wctx.old_extents,</span><br><span class="line">                          min_alloc_size);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// NB: _wctx_finish() will empty old_extents</span></span><br><span class="line">  <span class="comment">// so we must do gc estimation before that</span></span><br><span class="line">  _wctx_finish(txc, c, o, &amp;wctx);</span><br><span class="line">  <span class="keyword">if</span> (end &gt; o-&gt;onode.size) &#123;</span><br><span class="line">    <span class="built_in">dout</span>(<span class="number">20</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; extending size to 0x&quot;</span> &lt;&lt; std::hex &lt;&lt; end</span><br><span class="line">             &lt;&lt; std::dec &lt;&lt; dendl;</span><br><span class="line">    o-&gt;onode.size = end;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (benefit &gt;= <span class="built_in">g_conf</span>()-&gt;bluestore_gc_enable_total_threshold) &#123;</span><br><span class="line">    wctx.extents_to_gc.<span class="built_in">union_of</span>(gc.<span class="built_in">get_extents_to_collect</span>());</span><br><span class="line">    <span class="built_in">dout</span>(<span class="number">20</span>) &lt;&lt; __func__</span><br><span class="line">             &lt;&lt; <span class="string">&quot; perform garbage collection for compressed extents, &quot;</span></span><br><span class="line">             &lt;&lt; <span class="string">&quot;expected benefit = &quot;</span> &lt;&lt; benefit &lt;&lt; <span class="string">&quot; AUs&quot;</span> &lt;&lt; dendl;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!wctx.extents_to_gc.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">    <span class="built_in">dout</span>(<span class="number">20</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; perform garbage collection&quot;</span> &lt;&lt; dendl;</span><br><span class="line"></span><br><span class="line">    r = _do_gc(txc, c, o, wctx, &amp;dirty_start, &amp;dirty_end);</span><br><span class="line">    <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      derr &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; _do_gc failed with &quot;</span> &lt;&lt; <span class="built_in">cpp_strerror</span>(r) &lt;&lt; dendl;</span><br><span class="line">      <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">dout</span>(<span class="number">20</span>) &lt;&lt; __func__ &lt;&lt; <span class="string">&quot; gc range is &quot;</span> &lt;&lt; std::hex &lt;&lt; dirty_start &lt;&lt; <span class="string">&quot;~&quot;</span></span><br><span class="line">             &lt;&lt; dirty_end - dirty_start &lt;&lt; std::dec &lt;&lt; dendl;</span><br><span class="line">  &#125;</span><br><span class="line">  o-&gt;extent_map.<span class="built_in">compress_extent_map</span>(dirty_start, dirty_end - dirty_start);</span><br><span class="line">  o-&gt;extent_map.<span class="built_in">dirty_range</span>(dirty_start, dirty_end - dirty_start);</span><br><span class="line"></span><br><span class="line">  r = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">  <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="1-1-do-write-data"><a href="#1-1-do-write-data" class="headerlink" title="1.1 _do_write_data"></a>1.1 _do_write_data</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//file:BlueStore.cc</span></span><br><span class="line"><span class="comment">//backtrace:BlueStore::queue_transactions-&gt;BlueStore::_txc_add_transaction-&gt;BlueStore::_write-&gt;BlueStore::_do_write-&gt;BlueStore::_do_write_data</span></span><br><span class="line"><span class="type">void</span> BlueStore::_do_write_data(TransContext* txc, CollectionRef&amp; c, OnodeRef&amp; o,</span><br><span class="line">                               <span class="type">uint64_t</span> offset, <span class="type">uint64_t</span> length, bufferlist&amp; bl,</span><br><span class="line">                               WriteContext* wctx) &#123;</span><br><span class="line">  <span class="type">uint64_t</span> end = offset + length;</span><br><span class="line">  bufferlist::iterator p = bl.<span class="built_in">begin</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (offset / min_alloc_size == (end - <span class="number">1</span>) / min_alloc_size &amp;&amp;</span><br><span class="line">      (length != min_alloc_size)) &#123;</span><br><span class="line">    <span class="comment">// we fall within the same block</span></span><br><span class="line">    _do_write_small(txc, c, o, offset, length, p, wctx);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="type">uint64_t</span> head_offset, head_length;</span><br><span class="line">    <span class="type">uint64_t</span> middle_offset, middle_length;</span><br><span class="line">    <span class="type">uint64_t</span> tail_offset, tail_length;</span><br><span class="line"></span><br><span class="line">    head_offset = offset;</span><br><span class="line">    head_length = <span class="built_in">p2nphase</span>(offset, min_alloc_size);</span><br><span class="line"></span><br><span class="line">    tail_offset = <span class="built_in">p2align</span>(end, min_alloc_size);</span><br><span class="line">    tail_length = <span class="built_in">p2phase</span>(end, min_alloc_size);</span><br><span class="line"></span><br><span class="line">    middle_offset = head_offset + head_length;</span><br><span class="line">    middle_length = length - head_length - tail_length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (head_length) &#123;</span><br><span class="line">      _do_write_small(txc, c, o, head_offset, head_length, p, wctx);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">uint32_t</span> segment_size = o-&gt;onode.segment_size;</span><br><span class="line">    <span class="keyword">if</span> (segment_size) &#123;</span><br><span class="line">      <span class="comment">// split data to chunks</span></span><br><span class="line">      <span class="type">uint64_t</span> write_offset = middle_offset;</span><br><span class="line">      <span class="keyword">while</span> (write_offset &lt; middle_offset + middle_length) &#123;</span><br><span class="line">        <span class="type">uint64_t</span> segment_end =</span><br><span class="line">            std::<span class="built_in">min</span>(<span class="built_in">p2roundup</span>&lt;<span class="type">uint64_t</span>&gt;(write_offset + <span class="number">1</span>, segment_size),</span><br><span class="line">                     middle_offset + middle_length);</span><br><span class="line">        _do_write_big(txc, c, o, write_offset, segment_end - write_offset, p,</span><br><span class="line">                      wctx);</span><br><span class="line">        write_offset = segment_end;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      _do_write_big(txc, c, o, middle_offset, middle_length, p, wctx);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tail_length) &#123;</span><br><span class="line">      _do_write_small(txc, c, o, tail_offset, tail_length, p, wctx);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如下图所示<code>_do_writ_data</code>根据 <code>min_alloc_size</code> 来切分 [offset, length] 的写，然后分别依据<code>_do_write_small</code>和 <code>_do_write_big</code>来处理</p>
<p><img src="small_or_big_write.drawio.png" alt="small_or_big_write.drawio"></p>
<h6 id="1-1-1-do-write-small"><a href="#1-1-1-do-write-small" class="headerlink" title="1.1.1 _do_write_small"></a>1.1.1 _do_write_small</h6><p><img src="image-20260115212607575.png" alt="image-20260115212607575"></p>
<h6 id="1-1-2-do-write-big"><a href="#1-1-2-do-write-big" class="headerlink" title="1.1.2 _do_write_big"></a>1.1.2 _do_write_big</h6><center>To Be Continued</center>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://Rebelliousness.github.io">Rebellion</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://rebelliousness.github.io/2026/01/15/BlueStore%E5%86%99%E5%85%A5%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">https://rebelliousness.github.io/2026/01/15/BlueStore%E5%86%99%E5%85%A5%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ceph/">ceph</a></div><div class="post-share"><div class="social-share" data-image="/img/butterfly-icon.png" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/2025/12/11/ceph%E7%BC%96%E8%AF%91%E8%B0%83%E8%AF%95/" title="ceph编译调试"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">ceph编译调试</div></div><div class="info-2"><div class="info-item-1">一、获取ceph源码12345export http_proxy=&quot;http://127.0.0.1:7890&quot;export https_proxy=&quot;http://127.0.0.1:7890&quot;git clone https://github.com/ceph/ceph.gitcd ./cephgit submodule update  --recursive --init  二、安装依赖项12cd ceph./install-deps.sh  三、编译ceph123./do_cmake.sh -DWITH_MANPAGE=OFF -DWITH_BABELTRACE=OFF -DWITH_MGR_DASHBOARD_FRONTEND=OFF -DCMAKE_BUILD_TYPE=Degug -DWITH_CCACHE=OFF -DSPAWN_TEST_ADDRESS_SANITIZER=OFF -DWITH_DMCLOCK_TESTS=OFF -DWITH_GTEST_PARALLEL=OFF -DWITH_SYSTEM_GTEST=OF...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/12/11/ceph%E7%BC%96%E8%AF%91%E8%B0%83%E8%AF%95/" title="ceph编译调试"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-12-11</div><div class="info-item-2">ceph编译调试</div></div><div class="info-2"><div class="info-item-1">一、获取ceph源码12345export http_proxy=&quot;http://127.0.0.1:7890&quot;export https_proxy=&quot;http://127.0.0.1:7890&quot;git clone https://github.com/ceph/ceph.gitcd ./cephgit submodule update  --recursive --init  二、安装依赖项12cd ceph./install-deps.sh  三、编译ceph123./do_cmake.sh -DWITH_MANPAGE=OFF -DWITH_BABELTRACE=OFF -DWITH_MGR_DASHBOARD_FRONTEND=OFF -DCMAKE_BUILD_TYPE=Degug -DWITH_CCACHE=OFF -DSPAWN_TEST_ADDRESS_SANITIZER=OFF -DWITH_DMCLOCK_TESTS=OFF -DWITH_GTEST_PARALLEL=OFF -DWITH_SYSTEM_GTEST=OF...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/butterfly-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Rebellion</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">3</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">1</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Rebelliousness"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">1.</span> <span class="toc-text">一、准备工作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E9%85%8D%E7%BD%AEceph-conf%EF%BC%8C%E9%98%B2%E6%AD%A2osd-op-thread%E7%BA%BF%E7%A8%8B%E8%B6%85%E6%97%B6suicide"><span class="toc-number">1.1.</span> <span class="toc-text">1、配置ceph.conf，防止osd_op_thread线程超时suicide</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E5%88%9B%E5%BB%BApool"><span class="toc-number">1.2.</span> <span class="toc-text">2、创建pool</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81ceph%E4%B9%8Bbufferlist"><span class="toc-number">1.3.</span> <span class="toc-text">3、ceph之bufferlist</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%86%99%E5%85%A5%E6%B5%81%E7%A8%8B%E5%A0%86%E6%A0%88"><span class="toc-number">2.</span> <span class="toc-text">二、写入流程堆栈</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81BlueStore-queue-transactions%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">三、BlueStore::queue_transactions源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81BlueStore-txc-add-transaction"><span class="toc-number">3.1.</span> <span class="toc-text">1、BlueStore::_txc_add_transaction</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-do-write-data"><span class="toc-number">3.1.1.</span> <span class="toc-text">1.1 _do_write_data</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-1-1-do-write-small"><span class="toc-number">3.1.1.1.</span> <span class="toc-text">1.1.1 _do_write_small</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#1-1-2-do-write-big"><span class="toc-number">3.1.1.2.</span> <span class="toc-text">1.1.2 _do_write_big</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/01/15/BlueStore%E5%86%99%E5%85%A5%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" title="BlueStore写入流程源码分析">BlueStore写入流程源码分析</a><time datetime="2026-01-14T16:25:14.000Z" title="Created 2026-01-15 00:25:14">2026-01-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/11/ceph%E7%BC%96%E8%AF%91%E8%B0%83%E8%AF%95/" title="ceph编译调试">ceph编译调试</a><time datetime="2025-12-10T16:35:37.000Z" title="Created 2025-12-11 00:35:37">2025-12-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/10/17/hello-world/" title="Hello World">Hello World</a><time datetime="2025-10-17T15:45:04.906Z" title="Created 2025-10-17 23:45:04">2025-10-17</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 - 2026 By Rebellion</span><span class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 8.0.0</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.5.2</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.2"></script><script src="/js/main.js?v=5.5.2"></script><div class="js-pjax"></div><script async data-pjax src="/"></script></div></body></html>